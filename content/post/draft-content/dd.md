---
categories: database
date: "2022-10-01T00:00:00Z"
tags: ['transaction', 'database']
title: '# MySQL. InnoDB. 트랜잭션. 그리고 락'
draft: true
---

# 0. 서론
트랜잭션은 데이터베이스에서 빼놓을 수 없는 요소 중 하나입니다. 항상 트랜잭션에 대해서 '저건 내가 아직 알기 어려운거야' 라는 막연한 두려움을 갖고 있었는데, 이번에 트랜잭션을 공부할 기회가 생기면서 제대로 한번 도전해보고자 글을 작성하게 되었습니다. 틀린 내용을 발견하시면 언제든 댓글 부탁드립니다.

MySQL 과 InnoDB 를 중심으로 작성했습니다. 참고한 자료는 `Real MySQL 5.7` 과 `Real MySQL 8.0` 입니다만, 8.0 을 기준으로 최대한 말씀드리겠습니다.

# 1. 트랜잭션이란
트랜잭션에 대한 정의는 너무 흔하디 흔하지만, 그래도 한번 더 짚고 넘어가보겠습니다. 트랜잭션이란 이름에서 알수 있다 시피, '하나의 거래'를 의미합니다. 내가 마트에 가서 물건을 구매하고 대가로 돈을 지불하는 행위는 하나의 거래입니다. 이 둘은 개별적으로 존재할 수 없으며, 이를 조금 멋진 말로 '논리적 작업의 단위'라고 표현합니다. 트랜잭션은 `ACID` 란 이름의 다음의 4가지 성질을 가집니다.

- **A**tomicity(원자성) : 트랜잭션으로 묶인 일련의 작업들이 원자적으로 행해져야 한다는 의미입니다. 즉, 모두 성공하거나, 모두 실패해야 합니다. 
- **C**onsistency(일관성) : 트랜잭션의 실행이 성공적으로 이루어졌을 때, 제약 조건들이 위반되어서는 안된다는 뜻입니다. 가령 5천원이 들어있는 계좌에 두 개의 트랜잭션이 5천원을 빼는 작업을 성공하면 -5천원이 되는데, 이는 잔액이 0 원 이상이어야 한다는 제약조건에 어긋나므로 일관성을 지키지 못한 사례입니다.
- **I**solation(독립성) : 각 트랜잭션이 다른 트랜잭션의 영향을 받지 않아야 함을 의미합니다. 이는 뒤에서 설명할 격리 레벨과 관련하여 가장 유연하게 대응하는 제약조건입니다.
- **D**urability(지속성) : 성공적으로 트랜잭션이 수행되면 이는 영구적으로 반영되어야 함을 의미합니다. 이는 MySQL 의 로그와 연관이 있습니다.

# 2. 격리 레벨
ANSI 표준에 의해 정의된 격리 레벨은 다음의 4 단계로 이루어집니다.

1. Serializable
2. Repeatable Reads
3. Read Committed
4. Read uncommitted

위로 갈 수록(Serializable) 엄격하게, 아래로 갈수록(Read uncommitted) 느슨하게 트랜잭션을 관리합니다. 각 격리 레벨을 설명함에 있어 아래로부터 시작하는게 이해하는 게 편할 것 같습니다. 아래의 표를 기억해두면 격리 레벨을 이해하는데 큰 도움이 됩니다.


|격리 레벨|Dirty read|Non-repeatable read|phantom read|
|:--:|:--:|:--:|:--:|
|Read uncommitted| O | O | O |
|Read committed|  | O | O |
|Repeatable read|  |  | O |
|Serializable|  |  |  |

## 2.1. Read uncommitted
이름에서 알 수 있다시피, 커밋되지 않은 기록도 읽겠다는 의미입니다.

## 2.2. Read committed

## 2.3. Repeatable read

## 2.4. Serializable


# 3. 락
락에는 여러 종류가 있습니다. 락 이라는 이름을 공유하기는 하지만, 모두 같은 매커니즘으로 동작하지는 않습니다. 가령, 비관적 락(pessimistic lock)과 낙관적 락(optimistic lock)은 락이라는 전략을 '미리 문제가 발생하지 않도록 대비하자' 라는 관점에서 데이터베이스에서 처리할 수도 있고, 애플리케이션 레벨에서 처리할건지(문제가 발생하면 그 때 해결하자는 관점)

shared, read lock ... exclusive, write lock
